'use strict';

const ViberBot  = require(__dirname + '/../lib/viber-bot');
const BotEvents = require(__dirname + '/../lib/event-consts');
const TextMessage = require(__dirname + '/../lib/message/text-message');
const KeyboardMessage = require(__dirname + '/../lib/message/keyboard-message');
const fs = require('fs');
const SAMPLE_KEYBOARD = {
	"Type": "keyboard",
	"Revision": 1,
	"Buttons": [
		{
			"Columns": 3,
			"Rows": 2,
			"BgColor": "#e6f5ff",
			"BgMedia": "https://pbs.twimg.com/profile_images/564353911473967104/rDqJgxFZ.jpeg",
			"BgMediaType": "picture",
			"BgLoop": true,
			"ActionType": "reply",
			"ActionBody": "whatwhatwhatwhatwhatwhat"
		}
	]
};

const bot = new ViberBot({
	authToken: "45cbca856eefa904-d08e6f4eca452e7a-97b4826b05b88090",
	name: "EchoBot",
	avatar: "http://viber.com/avatar.jpg" // It is recommended to be 720x720, and no more than 100kb.
});

// Perfect! Now here's the key part:
bot.on(BotEvents.MESSAGE_RECEIVED, (message, response) => {
	// Echo's back the message to the client. Your bot logic should sit here.
	response.send([new TextMessage("hello from the other side"), new KeyboardMessage(SAMPLE_KEYBOARD)], null, (err, tokens) => console.log(`err${err}, tokens:${tokens}`));
});

// Wasn't that easy? Let's create HTTPS server and set the webhook:
const https = require('https');
const port  = 8443;

// Viber will push messages sent to this URL. Web server should be internet-facing.
const webhookUrl = "https://mysamplewebhook.com/webhook";

const httpsOptions = {
	key: fs.readFileSync(__dirname + '/../../keys/ssl-pems/server.key'),
	cert: fs.readFileSync(__dirname + '/../../keys/ssl-pems/server.crt'),
	ca: fs.readFileSync(__dirname + '/../../keys/ssl-pems/ca.pem')
}; // Trusted SSL certification (not self-signed).
https.createServer(httpsOptions, bot.middleware()).listen(port, () => bot.setWebhook(webhookUrl));
